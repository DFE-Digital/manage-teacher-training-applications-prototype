{% extends "_layout.njk" %}

{% set primaryNavId = 'organisations' %}
{% set trainingProvider = org.name %}
{% set title = trainingProvider %}

{% block pageNavigation %}
  {{ govukBreadcrumbs({
    items: [{
      text: "Your account",
      href: "/account"
    }, {
      text: "Organisational permissions",
      href: "/organisations"
    }, {
      text: title
    }]
  }) }}
{% endblock %}

{% block content %}

  {{ appBanner({
    html: "<h2 class=\"govuk-heading-m\">"+flashMessage+"</h2>",
    type: "success",
    icon: false
  }) if flashMessage }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-xl">Organisational permisions</span>
      <h1 class="govuk-heading-xl">{{title}}</h1>

      {% set tick %}
        {{ appIcon({
          classes: "govuk-!-margin-right-1",
          icon: "tick",
          hidden: true
        }) }}
      {% endset %}

      {% if relationships.length %}
        {% for relationship in relationships %}

          {% set title %}
            {% if relationship.org.isAccreditedBody %}
              For courses run by {{ relationship.partner.name }}
            {% else %}
              For courses ratified by {{ relationship.partner.name }}
            {% endif %}
          {% endset %}

          {% set makeDecisionsHtml %}
            {% if relationship.orgPermissions.makeDecisions or relationship.partnerPermissions.makeDecisions %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.makeDecisions %}
                  <li>{{tick | safe }} {{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.makeDecisions %}
                  <li>{{tick | safe }} {{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}

              {% if relationship.org.isAccreditedBody %}
                <p>{{ relationship.partner.name }} have not set up permissions for this yet – only they can set up permissions. Contact them to do this.</p>
                <p>Users can still view applications in the meantime.</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Users at {{ org.name}} and {{ relationship.partner.name }} cannot make decisions because you’ve not set this up yet – they can still view applications in the meantime.</p>
              {% endif %}


            {% endif %}
          {% endset %}
          {% set viewSafeguardingHtml %}
            {% if relationship.orgPermissions.safeguarding or relationship.partnerPermissions.safeguarding %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.safeguarding %}
                  <li>{{tick | safe }} {{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.safeguarding %}
                  <li>{{tick | safe }} {{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}
              {% if relationship.org.isAccreditedBody %}
                <p>{{ relationship.partner.name }} have not set up permissions for this yet – only they can set up permissions. Contact them to do this.</p>
                <p>Users can still view applications in the meantime.</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Users at {{ org.name}} and {{ relationship.partner.name }} cannot see safeguarding information because you’ve not set this up yet – they can still view applications in the meantime.</p>
              {% endif %}
            {% endif %}
          {% endset %}
          {% set viewDiversityHtml %}
            {% if relationship.orgPermissions.diversity or relationship.partnerPermissions.diversity %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.diversity %}
                  <li>{{tick | safe }} {{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.diversity %}
                  <li>{{tick | safe }} {{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}
              {% if relationship.org.isAccreditedBody %}
                <p>{{ relationship.partner.name }} have not set up permissions for this yet – only they can set up permissions. Contact them to do this.</p>
                <p>Users can still view applications in the meantime.</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Users at {{ org.name}} and {{ relationship.partner.name }} cannot see diversity information because you’ve not set this up yet – they can still view applications in the meantime.</p>
              {% endif %}
            {% endif %}
          {% endset %}

          {% set editLink %}
            /organisations/{{org.id}}/edit
          {% endset %}

          {% set cardHtml %}

            {% if relationship.org.isAccreditedBody %}

              <p class="govuk-!-margin-bottom-4">Only {{relationship.partner.name}} can change permissions because they run the courses. Contact them to do this.</p>

            {% endif %}

            {{ govukSummaryList({
              rows: [
                {
                  key: {
                    text: "Which organisations can make decisions?"
                  },
                  value: {
                    html: makeDecisionsHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "name"
                      }
                    ]
                  } if 1 == 2
                },
                {
                  key: {
                    text: "Which organisations can view safeguarding information?"
                  },
                  value: {
                    html: viewSafeguardingHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "name"
                      }
                    ]
                  } if 1 == 2
                },
                {
                  key: {
                    text: "Which organisations can view diversity information?"
                  },
                  value: {
                    html: viewDiversityHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "permissions for " + org.name
                      }
                    ]
                  } if 1 == 2
                }
              ]
            }) }}
          {% endset %}

          {{appSummaryCard({
            titleText: title,
            classes: "govuk-!-margin-bottom-6",
            actions: {
              items: [{
                href: editLink,
                text: "Change"
              }]
            } if not relationship.org.isAccreditedBody,
            html: cardHtml
          })}}
        {% endfor %}
      {% else %}
        <p class="govuk-!-margin-bottom-0">This organisation runs and ratifies its own courses. No permissions to set up.</p>
      {% endif %}

    </div>
  </div>

{% endblock %}
