{% set nationalityText %}
  {% set nationalities = application.personalDetails.nationality %}
  {%- for nationality in nationalities -%}
    {{ (" and " if loop.last else ", ") if not loop.first }}{{ nationality }}
  {%- endfor -%}
{% endset %}

{# Whether viewing user has ‘view diversity information’ permission on their account #}
{% set userHasViewDiversityInformationPermission = false %}

{# Shown when users are not allowed to see diversity information (sex, ethnicity, disabilities) #}
{% set offerContext = 'your' if application.status=='Offered' else 'an' %}

{% set diversityInformationPlaceholder %}
  {% if userHasViewDiversityInformationPermission %}
    {# Original line #}
    {# <p class="govuk-hint">Available when the candidate accepts your offer</p> #}

    {# Possible alternative #}
    <p class="govuk-body">Only available when {{offerContext}} offer has been accepted.</p>
  {% else %}
    <p class="govuk-body">Only available to users with ‘view diversity information’ permission when {{offerContext}} offer has been accepted.</p>
  {% endif %}
{% endset %}

{% set canViewDiversityInformation = (application.status == "Accepted" or application.status == "Conditions met") %}

{% if canViewDiversityInformation %}
  {% set sexText = application.personalDetails.sex %}
  {% set ethnicGroupText = application.personalDetails.ethnicGroup %}
  {% if application.personalDetails.disabled == "Yes" %}
    {% set disabilityText = application.personalDetails.disabled + ": " + "hearing, mobility" %}
  {% else %}
    {% set disabilityText = application.personalDetails.disabled %}
  {% endif %}
{% else %}

  {% set sexText = diversityInformationPlaceholder %}
  {% set ethnicGroupText = diversityInformationPlaceholder %}
  {% set disabilityText = diversityInformationPlaceholder %}

{% endif %}

{# <h2 class="govuk-heading-l">Application</h2> #}

{{ govukSummaryList({
  rows: [{
    key: {
      text: "Submitted"
    },
    value: {
      text: application.submittedDate | date("d LLLL yyyy") + " at " + note.date | time
    }
  }, {
    key: {
      text: "Cycle"
    },
    value: {
      text: application.cycle
    },
    actions: {
      items: [
        {
          href: '/application/' + application.id + '/cycle/edit',
          text: "Change",
          visuallyHiddenText: "cycle"
        }
      ]
    }
  },{
    key: {
      text: "Reference"
    },
    value: {
      text: application.id
    }
  }]
}) }}

<h2 class="govuk-heading-l">Applicant details</h2>

{{ govukSummaryList({
  rows: [{
    key: {
      text: "Full name"
    },
    value: {
      text: name
    }
  },  {
    key: {
      text: "Date of birth"
    },
    value: {
      text: application.personalDetails.dateOfBirth | govukDate
    }
  },{
    key: {
      text: "Nationality"
    },
    value: {
      text: nationalityText
    }
  },{
    key: {
      text: "Has the right to work or study in the UK?"
    },
    value: {
      text: application.personalDetails.residency.rightToWorkStudy
    }
  } if application.personalDetails.residency, {
    key: {
      text: "Residency details"
    },
    value: {
      text: application.personalDetails.residency.details
    }
  } if application.personalDetails.residency.details, {
    key: {
      text: "Phone number"
    },
    value: {
      html: "<a href=\"tel:" + application.contactDetails.tel | replace(" ", "") + "\">" + application.contactDetails.tel + "</a>"
    }
  }, {
    key: {
      text: "Email address"
    },
    value: {
      html: "<a href=\"mailto:" + application.contactDetails.email + "\">" + application.contactDetails.email + "</a>"
    }
  }, {
    key: {
      text: "Address"
    },
    value: {
      html: application.contactDetails.address | toArray | join("<br>") if application.contactDetails.address else "No information shared"
    }
  }]
}) }}

<h2 class="govuk-heading-l">Diversity information</h2>
<p class="govuk-body">The candidate filled out the equality questionnaire.</p>
{% if not canViewDiversityInformation %}
  {{ diversityInformationPlaceholder | safe }}
{% endif %}

{% if canViewDiversityInformation %}
  {{ govukSummaryList({
    rows: [{
      key: {
        text: "Sex"
      },
      value: {
        html: sexText
      }
    }, {
      key: {
        text: "Ethnic group"
      },
      value: {
        html: ethnicGroupText
      }
    }, {
      key: {
        text: "Disability"
      },
      value: {
        html: disabilityText
      }
    }
    ]
  }) }}
{% endif %}
