{% extends "_content-wide.njk" %}

{% set title = "Applications" %}
{% set parent = "2019-20 recruitment cycle" %}

{% block primary %}
  {% set applications = data.applications | toArray %}
  {% set new = applications | filterByStatus("new") %}
  {% set offer = applications | filterByStatus("offer") %}
  {% set accepted = applications | filterByStatus("accepted") %}
  {% set declined = applications | filterByStatus("declined") %}
  {% set rejected = applications | filterByStatus("rejected") %}

  {% if status == "new" %}
    {% set applications = new %}
  {% elif status == "offer" %}
    {% set applications = offer %}
  {% elif status == "accepted" %}
    {% set applications = accepted %}
  {% elif status == "declined" %}
    {% set applications = declined %}
  {% elif status == "rejected" %}
    {% set applications = rejected %}
  {% endif %}
  <table class="govuk-table" data-module="sortable-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="col" aria-sort="none">Name</th>
        <th class="govuk-table__header govuk-!-width-one-third" scope="col" aria-sort="none">Course</th>
        <th class="govuk-table__header" scope="col" aria-sort="none">Status</th>
        <th class="govuk-table__header govuk-table__header--numeric" scope="col" aria-sort="descending">Last updated</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {% for a in applications | reverse %}
      {% set rbd = a.status.submitted.date | addDays(40) %}
      {% set remaining = rbd | daysFromNow(rbd) %}
      {% set updated = a.status.rejected.date or a.status.declined.date or a.status.accepted.date or a.status.offer.date or a.status.submitted.date %}
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">
          <a href="/application/{{ a.id }}">{{ [a["personal-details"]["given-name"], a["personal-details"]["family-name"]] | join(" ") }}</a>
        </td>
        <td class="govuk-table__cell">{{ a.course }}</td>
        <td class="govuk-table__cell">
          {{ govukTag({
            classes: "app-tag--" + a.status | status,
            text: a.status | status | capitalize
          }) }}
        </td>
        <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ a.submitted | date("yyyyMMdd") }}">{{ updated | date("d LLL yyyy") }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% endblock %}
