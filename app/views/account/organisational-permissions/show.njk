{% extends "_layout.njk" %}

{% set primaryNavId = 'organisations' %}
{% set trainingProvider = org.name %}
{% set title = trainingProvider + " - Organisational permissions" %}

{% block pageNavigation %}
  {{ govukBreadcrumbs({
    items: [{
      text: "Your account",
      href: "/account"
    }, {
      text: "Organisational permissions",
      href: "/account/organisational-permissions"
    }, {
      text: trainingProvider
    }]
  }) }}
{% endblock %}

{% block content %}

  {{ govukNotificationBanner({
    html: "<h2 class=\"govuk-heading-m\">"+flash+"</h2>",
    type: "success",
    icon: false
  }) if flash | falsify }}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">Organisational permissions</span>
        {{trainingProvider}}
      </h1>

      {% if org.isAccreditedBody %}
        <p>Only training providers can change organisational permissions.</p>
      {% endif %}

      {% if relationships.length %}
        {% for relationship in relationships %}

          {% set title %}
            {{relationship.org.name}} and {{ relationship.partner.name }}
          {% endset %}

          {% set makeDecisionsHtml %}
            {% if relationship.orgPermissions.makeDecisions or relationship.partnerPermissions.makeDecisions %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.makeDecisions %}
                  <li>{{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.makeDecisions %}
                  <li>{{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}
              {% if relationship.org.isAccreditedBody %}
                <p>Nobody can do this - the training provider needs to change organisational permissions</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Change permissions to allow an organisation to do this</p>
              {% endif %}
            {% endif %}
          {% endset %}
          {% set viewSafeguardingHtml %}
            {% if relationship.orgPermissions.viewSafeguardingInformation or relationship.partnerPermissions.viewSafeguardingInformation %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.viewSafeguardingInformation %}
                  <li>{{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.viewSafeguardingInformation %}
                  <li>{{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}
              {% if relationship.org.isAccreditedBody %}
                <p>Nobody can do this - the training provider needs to change organisational permissions</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Change permissions to allow an organisation to do this</p>
              {% endif %}
            {% endif %}
          {% endset %}
          {% set viewDiversityHtml %}
            {% if relationship.orgPermissions.viewDiversityInformation or relationship.partnerPermissions.viewDiversityInformation %}
              <ul class="govuk-list">
                {% if relationship.orgPermissions.viewDiversityInformation %}
                  <li>{{ relationship.org.name }}</li>
                {% endif %}
                {% if relationship.partnerPermissions.viewDiversityInformation %}
                  <li>{{ relationship.partner.name }}</li>
                {% endif %}
              </ul>
            {% else %}
              {% if relationship.org.isAccreditedBody %}
                <p>Nobody can do this - the training provider needs to change organisational permissions</p>
              {% else %}
                <p class="govuk-!-margin-bottom-0">Change permissions to allow an organisation to do this</p>
              {% endif %}
            {% endif %}
          {% endset %}

          {% set editLink %}
            /account/organisational-permissions/{{org.id}}/edit
          {% endset %}

          {% set cardHtml %}

            {% if relationship.org.isAccreditedBody %}

              {# <p class="govuk-!-margin-bottom-4">Only {{relationship.partner.name}} can change permissions because they run the courses. Contact them to change these settings.</p> #}

            {% endif %}

            {{ govukSummaryList({
              rows: [
                {
                  key: {
                    text: "Make decisions and set up interviews"
                  },
                  value: {
                    html: makeDecisionsHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "name"
                      }
                    ]
                  } if not relationship.org.isAccreditedBody
                },
                {
                  key: {
                    text: "View criminal convictions and professional misconduct"
                  },
                  value: {
                    html: viewSafeguardingHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "name"
                      }
                    ]
                  } if not relationship.org.isAccreditedBody
                },
                {
                  key: {
                    text: "View equality and diversity information"
                  },
                  value: {
                    html: viewDiversityHtml
                  },
                  actions: {
                    items: [
                      {
                        href: editLink,
                        text: "Change",
                        visuallyHiddenText: "permissions for " + org.name
                      }
                    ]
                  } if not relationship.org.isAccreditedBody
                }
              ]
            }) }}
          {% endset %}

          {{appSummaryCard({
            titleText: title,
            classes: "govuk-!-margin-bottom-6",
            html: cardHtml
          })}}
        {% endfor %}
      {% else %}
        <p class="govuk-!-margin-bottom-0">This organisation runs and ratifies its own courses. You do not need to set permissions for this.</p>
      {% endif %}

    </div>
  </div>

{% endblock %}
